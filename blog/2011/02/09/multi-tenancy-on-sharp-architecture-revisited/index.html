
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Multi-tenancy on S#arp Architecture Revisited - Yellow Feather Ltd</title>
  <meta name="author" content="Yellow Feather Ltd">

  
  <meta name="description" content="Following my previous post some issues were pointed out with the implementation, the main one being that the correct repository implementation was &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yellowfeather.co.uk/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Yellow Feather Ltd" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic|Istok+Web:400,400italic,700,700italic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-85823-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div id="header-container">
    <div id="header">
      <div class="wrapper">
        <header role="banner"><hgroup>
  <h1>
    <a href="/">
      <img src="/images/logo.png" class="standard">
      <img src="/images/logo-retina.png" class="retina" width="175" height="75">
    </a>
  </h1>
</hgroup>

</header>
        <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yellowfeather.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
      </div>
    </div>
  </div>
  <div id="body"   >
    <div id="main">
      <div id="content">
	<div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Multi-tenancy on S#arp Architecture Revisited</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-09T00:00:00+00:00" pubdate data-updated="true">Feb 9<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Following my <a href="/blog/2011/01/11/multi-tenancy-on-sharp-architecture">previous post</a> some issues were pointed out with the implementation, the main one being that the correct repository implementation was not resolved from an IRepository&lt;T&gt; interface (see the Google Group <a title="use custom IRepository interface in SharpModelBinder Options " href="http://groups.google.com/group/sharp-architecture/browse_thread/thread/3d8b190ada63a06b" target="_self">discussion</a> for more details).<a id="more"></a><a id="more-62"></a></p>

<p>As mentioned in the discussion I have made some minor modifications to <a title="S#arp Architecture" href="http://sharparchitecture.net/">S#arp Architecture</a> to solve this problem and better support multi-tenancy. You can see the changes in the <a title="Enabling multi-tenancy" href="https://github.com/sharparchitecture/Sharp-Architecture/pull/1" target="_self">pull request</a>, but it looks like they are now included in the <a title="1.9.5 Released" href="http://groups.google.com/group/sharp-architecture/browse_thread/thread/2091f202966654dc">latest release</a>.</p>

<p>The changes are very minor, and centre around the introduction of an interface, ISessionFactoryKeyProvider, so that it is possible to get the session factory key without having to use an attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">SharpArch.Data.NHibernate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">interface</span> <span class="n">ISessionFactoryKeyProvider</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;summary&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// Gets the session factory key.</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;/summary&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;returns&amp;gt;&amp;lt;/returns&amp;gt;</span>
</span><span class='line'>    <span class="kt">string</span> <span class="nf">GetKey</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">/// &amp;lt;summary&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// Gets the session factory key.</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;/summary&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;param name=&quot;anObject&quot;&amp;gt;An optional object that may have an attribute used to determine the session factory key.&amp;lt;/param&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;returns&amp;gt;&amp;lt;/returns&amp;gt;</span>
</span><span class='line'>    <span class="kt">string</span> <span class="nf">GetKeyFrom</span><span class="p">(</span><span class="kt">object</span> <span class="n">anObject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve created a default implementation of this interface that just delegates getting the key from the existing SessionFactoryAttribute.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">SharpArch.Data.NHibernate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">/// &amp;lt;summary&amp;gt;</span>
</span><span class='line'>  <span class="c1">/// Implementation of &amp;lt;see cref=&quot;ISessionFactoryKeyProvider&quot; /&amp;gt; that uses</span>
</span><span class='line'>  <span class="c1">/// the &amp;lt;see cref=&quot;SessionFactoryAttribute&quot; /&amp;gt; to determine the session</span>
</span><span class='line'>  <span class="c1">/// factory key.</span>
</span><span class='line'>  <span class="c1">/// &amp;lt;/summary&amp;gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DefaultSessionFactoryKeyProvider</span> <span class="p">:</span> <span class="n">ISessionFactoryKeyProvider</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetKey</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">DefaultFactoryKey</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">/// &amp;lt;summary&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// Gets the session factory key.</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;/summary&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;param name=&quot;anObject&quot;&amp;gt;An object that may have the &amp;lt;see cref=&quot;SessionFactoryAttribute&quot;/&amp;gt; applied.&amp;lt;/param&amp;gt;</span>
</span><span class='line'>    <span class="c1">/// &amp;lt;returns&amp;gt;&amp;lt;/returns&amp;gt;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetKeyFrom</span><span class="p">(</span><span class="kt">object</span> <span class="n">anObject</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">SessionFactoryAttribute</span><span class="p">.</span><span class="n">GetKeyFrom</span><span class="p">(</span><span class="n">anObject</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve also added a helper class SessionFactoryKeyHelper:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Core</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArch.Data.NHibernate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">SessionFactoryKeyHelper</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetKey</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">provider</span> <span class="p">=</span> <span class="n">SafeServiceLocator</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">ISessionFactoryKeyProvider</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;.</span><span class="n">GetService</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">provider</span><span class="p">.</span><span class="n">GetKey</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetKey</span><span class="p">(</span><span class="kt">object</span> <span class="n">anObject</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">provider</span> <span class="p">=</span> <span class="n">SafeServiceLocator</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">ISessionFactoryKeyProvider</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;.</span><span class="n">GetService</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">provider</span><span class="p">.</span><span class="n">GetKeyFrom</span><span class="p">(</span><span class="n">anObject</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now whenever S#arp Architecture requires a session factory key we can use the helper class, rather than using SessionFactoryAttribute e.g. in the Repository implementation the code is changed from:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">virtual</span> <span class="n">ISession</span> <span class="n">Session</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">get</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">factoryKey</span> <span class="p">=</span> <span class="n">SessionFactoryAttribute</span><span class="p">.</span><span class="n">GetKeyFrom</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">CurrentFor</span><span class="p">(</span><span class="n">factoryKey</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">virtual</span> <span class="n">ISession</span> <span class="n">Session</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">get</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">factoryKey</span> <span class="p">=</span> <span class="n">SessionFactoryKeyHelper</span><span class="p">.</span><span class="n">GetKey</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">CurrentFor</span><span class="p">(</span><span class="n">factoryKey</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note: this change to the Repository implementation means that the MultiTenantRepository class from my <a title="Multi-tenancy on S#arp Architecture" href="http://www.yellowfeather.co.uk/2011/01/multi-tenancy-on-sharp-architecture/" target="_self">previous post</a> is no longer required.</em></p>

<p>Similar changes are also made to TransactionAttribute and EntityDuplicateChecker.</p>

<p>If you do not need multi-tenancy, or are happy to use the existing TransactionAttribute to specify the session factory key, then you just need to register the DefaultSessionFactoryKeyProvider implementation in the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">container</span><span class="p">.</span><span class="n">AddComponent</span><span class="p">(</span><span class="s">&quot;sessionFactoryKeyProvider&quot;</span><span class="p">,</span> 
</span><span class='line'>  <span class="k">typeof</span><span class="p">(</span><span class="n">ISessionFactoryKeyProvider</span><span class="p">),</span>
</span><span class='line'>  <span class="k">typeof</span><span class="p">(</span><span class="n">DefaultSessionFactoryKeyProvider</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>But if you want to provide the session factory key by any other means, it is just a case of implementing and registering your implementation of ISessionFactoryKeyProvider.</p>

<p>In my <a title="SharpArchitecture-MultiTenant" href="https://github.com/yellowfeather/SharpArchitecture-MultiTenant" target="_self">sample application</a> I&#8217;ve implemented it as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Data.NHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Contracts</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Extensions</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.NHibernate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MultiTenantSessionFactoryKeyProvider</span> <span class="p">:</span> <span class="n">ISessionFactoryKeyProvider</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITenantContext</span> <span class="n">_tenantContext</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">MultiTenantSessionFactoryKeyProvider</span><span class="p">(</span><span class="n">ITenantContext</span> <span class="n">tenantContext</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">_tenantContext</span> <span class="p">=</span> <span class="n">tenantContext</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetKey</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">_tenantContext</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">?</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">DefaultFactoryKey</span> <span class="p">:</span> <span class="n">key</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetKeyFrom</span><span class="p">(</span><span class="kt">object</span> <span class="n">anObject</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">type</span> <span class="p">=</span> <span class="n">anObject</span><span class="p">.</span><span class="n">GetType</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">IsMultiTenantRepository</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="n">IsRepositoryForMultiTenantEntity</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span><span class='line'>        <span class="p">?</span> <span class="n">GetKey</span><span class="p">()</span>
</span><span class='line'>        <span class="p">:</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">DefaultFactoryKey</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsMultiTenantRepository</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">type</span><span class="p">.</span><span class="n">IsImplementationOf</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">IMultiTenantRepository</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsRepositoryForMultiTenantEntity</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(!</span><span class="n">type</span><span class="p">.</span><span class="n">IsGenericType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">var</span> <span class="n">genericTypes</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">GetGenericArguments</span><span class="p">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(!</span><span class="n">genericTypes</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">var</span> <span class="n">firstGenericType</span> <span class="p">=</span> <span class="n">genericTypes</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">firstGenericType</span><span class="p">.</span><span class="n">IsImplementationOf</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">IMultiTenantEntity</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This makes use of a couple of marker interfaces IMultiTenantEntity and IMultiTenantRepository to decide whether we need to get the tenant, or the default, session factory key. Actually getting the tenant session factory key is accomplished by the implementation of ITenantContext.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Web.Services</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">TenantContext</span> <span class="p">:</span> <span class="n">ITenantContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DefaultStorageKey</span> <span class="p">=</span> <span class="s">&quot;tenant-context-key&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Key</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">StoredKey</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">StoredKey</span> <span class="p">=</span> <span class="n">KeyFromRequest</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">StoredKey</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">set</span> <span class="p">{</span> <span class="n">StoredKey</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">KeyFromRequest</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&quot;HOST&quot;</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">domains</span> <span class="p">=</span> <span class="n">host</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">domains</span><span class="p">.</span><span class="n">Length</span> <span class="p">&amp;</span><span class="n">gt</span><span class="p">;=</span> <span class="m">3</span> <span class="p">?</span> <span class="n">domains</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">:</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="kt">string</span> <span class="n">StoredKey</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="n">DefaultStorageKey</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">set</span> <span class="p">{</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="n">DefaultStorageKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve update my <a title="SharpArchitecture-MultiTenant" href="https://github.com/yellowfeather/SharpArchitecture-MultiTenant" target="_self">sample application</a> on GitHub with these changes and to run against  S#arp Architecture v1.95.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yellow Feather Ltd</span></span>

      








  


<time datetime="2011-02-09T00:00:00+00:00" pubdate data-updated="true">Feb 9<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/multi-tenancy/'>Multi-tenancy</a>, <a class='category' href='/blog/categories/sharp-architecture/'>Sharp Architecture</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://yellowfeather.co.uk/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited/" data-via="yellowfeatheruk" data-counturl="http://yellowfeather.co.uk/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/01/11/multi-tenancy-on-sharp-architecture/" title="Previous Post: Multi-tenancy on S#arp Architecture Revisited">&laquo; Multi-tenancy on S#arp Architecture Revisited</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/03/21/enhanced-query-objects-with-sharp-architecture/" title="Next Post: Enhanced query objects with S#arp Architecture">Enhanced query objects with S#arp Architecture &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/04/getting-mono-running-on-amazon-linux-ami/">Getting Mono running on an Amazon Linux AMI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/05/web-site-moved-to-octopress/">Web site moved to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/11/auto-incrementing-build-number-in-xcode-4/">Auto incrementing build number in Xcode 4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/31/git-workflow-branch-per-feature/">Git Workflow – Branch per feature</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/26/userland-spi-on-the-beaglebone-with-ubuntu/">Userland SPI on the BeagleBone with Ubuntu</a>
      </li>
    
    <li class="post">
      <a href="/blog/archives">More</a>
    </li>
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/amazon-aws/'>Amazon AWS (1)</a></li>
<li class='category'><a href='/blog/categories/beaglebone/'>BeagleBone (1)</a></li>
<li class='category'><a href='/blog/categories/enhanced-query-objects/'>Enhanced Query Objects (1)</a></li>
<li class='category'><a href='/blog/categories/mono/'>Mono (1)</a></li>
<li class='category'><a href='/blog/categories/multi-tenancy/'>Multi-tenancy (2)</a></li>
<li class='category'><a href='/blog/categories/sharp-architecture/'>Sharp Architecture (3)</a></li>
<li class='category'><a href='/blog/categories/xcode/'>Xcode (1)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>iOS (1)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yellowfeatheruk", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yellowfeatheruk" class="twitter-follow-button" data-show-count="true">Follow @yellowfeatheruk</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/yellowfeather">@yellowfeather</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'yellowfeather',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:yellowfeather">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "yellowfeather"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>




  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Yellow Feather Ltd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'yellowfeather';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://yellowfeather.co.uk/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited/';
        var disqus_url = 'http://yellowfeather.co.uk/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Multi-tenancy on S#arp Architecture Revisited - Yellow Feather Ltd</title>
  <meta name="author" content="Yellow Feather Ltd">

  
  <meta name="description" content="Update: the code below is out of date, please see Multi-tenancy on S#arp Architecture Revisited for a better solution Recently I&#8217;ve been &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yellowfeather.co.uk/blog/2011/01/11/multi-tenancy-on-sharp-architecture/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Yellow Feather Ltd" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic|Istok+Web:400,400italic,700,700italic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-85823-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
  <div id="header-container">
    <div id="header">
      <div class="wrapper">
        <header role="banner"><hgroup>
  <h1>
    <a href="/">
      <img src="/images/logo.png" class="standard">
      <img src="/images/logo-retina.png" class="retina" width="175" height="75">
    </a>
  </h1>
</hgroup>

</header>
        <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yellowfeather.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
      </div>
    </div>
  </div>
  <div id="body"   >
    <div id="main">
      <div id="content">
	<div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Multi-tenancy on S#arp Architecture Revisited</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-11T00:00:00+00:00" pubdate data-updated="true">Jan 11<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>Update</strong>: the code below is out of date, please see <a href="/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited">Multi-tenancy on S#arp Architecture Revisited</a> for a better solution</p>

<p>Recently I&#8217;ve been working on adding multi-tenancy to a web application based on the excellent <a title="S#arp Architecture" href="http://sharparchitecture.net/">S#arp Architecture</a> and thought I&#8217;d share what I have so far.<a id="more"></a><a id="more-24"></a></p>

<p>This implementation is mainly based on this <a title="Implementing A Multi-Tenant ASP.NET MVC Application with S#arp Architecture" href="http://thatstoday.com/a/557835">post</a> from Robert Johnson, and uses a separate database for each tenant, along with a master database to hold the details of the tenants (and anything else you wish). The main drawback with using separate databases is handling the migrations, I haven&#8217;t yet got a solution to this but will look at a way of automating it using something like <a title="Migrator.Net" href="http://code.google.com/p/migratordotnet/">Migrator.Net</a> in a future post.</p>

<p>All of the domain entities inherit from SharpArch.Core.DomainModel.Entity, and I use a marker interface to indicate which entities are part of the tenant domain model.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Core.Contracts</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">/// &amp;lt;summary&amp;gt;</span>
</span><span class='line'>  <span class="c1">/// Marker interface for multi tenant entities.</span>
</span><span class='line'>  <span class="c1">/// &amp;lt;/summary&amp;gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">interface</span> <span class="n">IMultiTenantEntity</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now create our domain entities for the tenants:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">NHibernate.Validator.Constraints</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Core.DomainModel</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Core.Contracts</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Core</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Customer</span> <span class="p">:</span> <span class="n">Entity</span><span class="p">,</span> <span class="n">IMultiTenantEntity</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'><span class="na">    [DomainSignature]</span>
</span><span class='line'><span class="na">    [NotNullNotEmpty]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Code</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [DomainSignature]</span>
</span><span class='line'><span class="na">    [NotNullNotEmpty]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we create an entity, to be stored in the master database, to represent each tenant:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Core.DomainModel</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Core</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Tenant</span> <span class="p">:</span> <span class="n">Entity</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [DomainSignature]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">Domain</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">ConnectionString</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The application will make use of a separate NHibernate session for each tenant, identified by a key. For the master database the default session will be used. So, we create an interface that will provide access to the key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">interface</span> <span class="n">ITenantContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">Key</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we implement this interface based on the method we choose to identify tenants, in this case based on the subdomain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Web.Services</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">TenantContext</span> <span class="p">:</span> <span class="n">ITenantContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DefaultStorageKey</span> <span class="p">=</span> <span class="s">&quot;tenant-context-key&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Key</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">StoredKey</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">StoredKey</span> <span class="p">=</span> <span class="n">KeyFromRequest</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">StoredKey</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">set</span> <span class="p">{</span> <span class="n">StoredKey</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">KeyFromRequest</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">[</span><span class="s">&quot;HOST&quot;</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">domains</span> <span class="p">=</span> <span class="n">host</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">domains</span><span class="p">.</span><span class="n">Length</span> <span class="p">&amp;</span><span class="n">gt</span><span class="p">;=</span> <span class="m">3</span> <span class="p">?</span> <span class="n">domains</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">:</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="kt">string</span> <span class="n">StoredKey</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="n">DefaultStorageKey</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">set</span> <span class="p">{</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="n">DefaultStorageKey</span><span class="p">]</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If a different method of identifying tenants is required, say by a query string parameter, then it is just a case of providing a different implementation of ITenantContext.</p>

<p>We can now create a multi-tenant repository that uses ITenantContext to select the NHibernate session based on the key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">NHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Data.NHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Data.Repositories</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MultiTenantRepository</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">T</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">T</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITenantContext</span> <span class="n">_tenantContext</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">MultiTenantRepository</span><span class="p">(</span><span class="n">ITenantContext</span> <span class="n">tenantContext</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">_tenantContext</span> <span class="p">=</span> <span class="n">tenantContext</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="n">ISession</span> <span class="n">Session</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">_tenantContext</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">?</span> <span class="k">base</span><span class="p">.</span><span class="n">Session</span> <span class="p">:</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">CurrentFor</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we need to create a repository interface:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">MvcContrib.Pagination</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Core.PersistenceSupport</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Core.RepositoryInterfaces</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">interface</span> <span class="n">ICustomerRepository</span> <span class="p">:</span> <span class="n">IRepository</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">IPagination</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">GetPagedList</span><span class="p">(</span><span class="kt">int</span> <span class="n">pageIndex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and implementation for our multi-tenant entities:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">MvcContrib.Pagination</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">NHibernate.Criterion</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Core</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Core.RepositoryInterfaces</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Data.Repositories</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerRepository</span> <span class="p">:</span> <span class="n">MultiTenantRepository</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;,</span> <span class="n">ICustomerRepository</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">CustomerRepository</span><span class="p">(</span><span class="n">ITenantContext</span> <span class="n">tenantContext</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">tenantContext</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">IPagination</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">GetPagedList</span><span class="p">(</span><span class="kt">int</span> <span class="n">pageIndex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">firstResult</span> <span class="p">=</span> <span class="p">(</span><span class="n">pageIndex</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">pageSize</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">customers</span> <span class="p">=</span> <span class="n">Session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">customer</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">customer</span><span class="p">.</span><span class="n">Code</span><span class="p">).</span><span class="n">Asc</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="n">firstResult</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="n">pageSize</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Future</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">var</span> <span class="n">totalCount</span> <span class="p">=</span> <span class="n">Session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">Count</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;(</span><span class="n">customer</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">customer</span><span class="p">.</span><span class="n">Code</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">FutureValue</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="kt">int</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="n">CustomPagination</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Customer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;(</span><span class="n">customers</span><span class="p">,</span> <span class="n">pageIndex</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">,</span> <span class="n">totalCount</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our controllers can now make use of ICustomerRepository without having to worry about any of the multi-tenancy issues.</p>

<p>We also need to update the TransactionAttribute so that it makes use of the appropriate NHibernate session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">Microsoft.Practices.ServiceLocation</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.NHibernate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">TransactionAttribute</span> <span class="p">:</span> <span class="n">SharpArch</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">NHibernate</span><span class="p">.</span><span class="n">TransactionAttribute</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">TransactionAttribute</span><span class="p">()</span>
</span><span class='line'>      <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">FactoryKey</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">FactoryKey</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">tenantContext</span> <span class="p">=</span> <span class="n">ServiceLocator</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">ITenantContext</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">tenantContext</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up, we need to update the initialisation in Global.asax.cs so that we create a session factory for the master database and also for each tenant:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>    <span class="k">private</span> <span class="k">void</span> <span class="nf">InitializeNHibernateSession</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">mappingAssemblies</span> <span class="p">=</span> <span class="k">new</span> <span class="p">[]</span> <span class="p">{</span> <span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="s">&quot;~/bin/SharpArchitecture.MultiTenant.Data.dll&quot;</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">var</span> <span class="n">configFile</span> <span class="p">=</span> <span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="s">&quot;~/NHibernate.config&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span>
</span><span class='line'>            <span class="n">webSessionStorage</span><span class="p">,</span>
</span><span class='line'>            <span class="n">mappingAssemblies</span><span class="p">,</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">AutoPersistenceModelGenerator</span><span class="p">().</span><span class="n">Generate</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">configFile</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">tenantConfigFile</span> <span class="p">=</span> <span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="s">&quot;~/NHibernate.tenant.config&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">multiTenantInitializer</span> <span class="p">=</span> <span class="n">ServiceLocator</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">IMultiTenantInitializer</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
</span><span class='line'>        <span class="n">multiTenantInitializer</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">mappingAssemblies</span><span class="p">,</span> <span class="k">new</span> <span class="n">MultiTenantAutoPersistenceModelGenerator</span><span class="p">(),</span>  <span class="n">tenantConfigFile</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the code above, the standard NHibernate.config file is used to configure the master database. Whilst NHibernate.tenant.config, along with the connection string provided by the Tenant, is used to configure the tenant databases:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Data.NHibernate.FluentNHibernate</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">interface</span> <span class="n">IMultiTenantInitializer</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">mappingAssemblies</span><span class="p">,</span> <span class="n">IAutoPersistenceModelGenerator</span> <span class="n">modelGenerator</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tenantConfigFile</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">NHibernate.Cfg</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Core.PersistenceSupport</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Data.NHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArch.Data.NHibernate.FluentNHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Core</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.Services</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Framework.NHibernate</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MultiTenantInitializer</span> <span class="p">:</span> <span class="n">IMultiTenantInitializer</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IRepository</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Tenant</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">_tenantRepository</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">MultiTenantInitializer</span><span class="p">(</span><span class="n">IRepository</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Tenant</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">tenantRepository</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">_tenantRepository</span> <span class="p">=</span> <span class="n">tenantRepository</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">mappingAssemblies</span><span class="p">,</span> <span class="n">IAutoPersistenceModelGenerator</span> <span class="n">modelGenerator</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tenantConfigFile</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">tenants</span> <span class="p">=</span> <span class="n">_tenantRepository</span><span class="p">.</span><span class="n">GetAll</span><span class="p">();</span>
</span><span class='line'>      <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">tenant</span> <span class="k">in</span> <span class="n">tenants</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Initialize</span><span class="p">(</span><span class="n">mappingAssemblies</span><span class="p">,</span> <span class="n">modelGenerator</span><span class="p">,</span> <span class="n">tenantConfigFile</span><span class="p">,</span> <span class="n">tenant</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">mappingAssemblies</span><span class="p">,</span> <span class="n">IAutoPersistenceModelGenerator</span> <span class="n">modelGenerator</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tenantConfigFile</span><span class="p">,</span> <span class="n">Tenant</span> <span class="n">tenant</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">properties</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'>                         <span class="p">{</span>
</span><span class='line'>                           <span class="p">{</span> <span class="s">&quot;connection.connection_string&quot;</span><span class="p">,</span> <span class="n">tenant</span><span class="p">.</span><span class="n">ConnectionString</span> <span class="p">}</span>
</span><span class='line'>                         <span class="p">};</span>
</span><span class='line'>      <span class="n">AddTenantConfiguration</span><span class="p">(</span><span class="n">tenant</span><span class="p">.</span><span class="n">Domain</span><span class="p">,</span> <span class="n">mappingAssemblies</span><span class="p">,</span> <span class="n">modelGenerator</span><span class="p">,</span> <span class="n">tenantConfigFile</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Configuration</span> <span class="nf">AddTenantConfiguration</span><span class="p">(</span><span class="kt">string</span> <span class="n">factoryKey</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">mappingAssemblies</span><span class="p">,</span> <span class="n">IAutoPersistenceModelGenerator</span> <span class="n">modelGenerator</span><span class="p">,</span> <span class="kt">string</span> <span class="n">cfgFile</span><span class="p">,</span> <span class="n">IDictionary</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">cfgProperties</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">NHibernateSession</span><span class="p">.</span><span class="n">AddConfiguration</span><span class="p">(</span><span class="n">factoryKey</span><span class="p">,</span>
</span><span class='line'>        <span class="n">mappingAssemblies</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modelGenerator</span><span class="p">.</span><span class="n">Generate</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">cfgFile</span><span class="p">,</span>
</span><span class='line'>        <span class="n">cfgProperties</span><span class="p">,</span>
</span><span class='line'>        <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code iterates through the list of tenants from the master database, setting the connection string and session factory key from the tenant properties and adds the configuration to NHibernate.</p>

<p>All that is left is to generate the mappings. In AutoPersistenceModelGenerator we move the creation of the standard mapping configuration into a method so that it can be overridden:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">virtual</span> <span class="n">IAutomappingConfiguration</span> <span class="nf">GetAutomappingConfiguration</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">AutomappingConfiguration</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And derive from AutoPersistenceModelGenerator to create our multi-tenant mapping configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">FluentNHibernate.Automapping</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Data.NHibernateMaps</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MultiTenantAutoPersistenceModelGenerator</span> <span class="p">:</span> <span class="n">AutoPersistenceModelGenerator</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="n">IAutomappingConfiguration</span> <span class="nf">GetAutomappingConfiguration</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">MultiTenantAutomappingConfiguration</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we add a method to AutomappingConfiguration to determine if a type is a multi-tenant entity (by checking to see if the type implements our IMultiTenantEntity interface):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsMultiTenantEntity</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">type</span><span class="p">.</span><span class="n">GetInterfaces</span><span class="p">().</span><span class="n">Any</span><span class="p">(</span><span class="n">x</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">x</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IMultiTenantEntity</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and update the ShouldMap method to only map entities that are not multi-tenant:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">ShouldMap</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">isMultiTenantEntity</span> <span class="p">=</span> <span class="n">IsMultiTenantEntity</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">shouldMap</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">GetInterfaces</span><span class="p">().</span><span class="n">Any</span><span class="p">(</span><span class="n">x</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'>                                  <span class="n">x</span><span class="p">.</span><span class="n">IsGenericType</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetGenericTypeDefinition</span><span class="p">()</span> <span class="p">==</span> <span class="k">typeof</span> <span class="p">(</span><span class="n">IEntityWithTypedId</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;&amp;</span><span class="n">gt</span><span class="p">;)</span> <span class="p">&amp;</span><span class="n">amp</span><span class="p">;&amp;</span><span class="n">amp</span><span class="p">;</span>
</span><span class='line'>                                  <span class="p">!</span><span class="n">isMultiTenantEntity</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">shouldMap</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is then a case of deriving from AutomappingConfiguration to map the multi-tenant entities:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">SharpArchitecture.MultiTenant.Data.NHibernateMaps</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">/// &amp;lt;summary&amp;gt;</span>
</span><span class='line'>  <span class="c1">///</span>
</span><span class='line'>  <span class="c1">/// &amp;lt;/summary&amp;gt;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MultiTenantAutomappingConfiguration</span> <span class="p">:</span> <span class="n">AutomappingConfiguration</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">ShouldMap</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">shouldMap</span> <span class="p">=</span> <span class="n">IsMultiTenantEntity</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">shouldMap</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <a title="sample application" href="https://github.com/yellowfeather/SharpArchitecture-MultiTenant">sample application</a> is available on GitHub.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yellow Feather Ltd</span></span>

      








  


<time datetime="2011-01-11T00:00:00+00:00" pubdate data-updated="true">Jan 11<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/multi-tenancy/'>Multi-tenancy</a>, <a class='category' href='/blog/categories/sharp-architecture/'>Sharp Architecture</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://yellowfeather.co.uk/blog/2011/01/11/multi-tenancy-on-sharp-architecture/" data-via="yellowfeatheruk" data-counturl="http://yellowfeather.co.uk/blog/2011/01/11/multi-tenancy-on-sharp-architecture/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2011/02/09/multi-tenancy-on-sharp-architecture-revisited/" title="Next Post: Multi-tenancy on S#arp Architecture Revisited">Multi-tenancy on S#arp Architecture Revisited &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/04/getting-mono-running-on-amazon-linux-ami/">Getting Mono running on an Amazon Linux AMI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/05/web-site-moved-to-octopress/">Web site moved to Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/11/auto-incrementing-build-number-in-xcode-4/">Auto incrementing build number in Xcode 4</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/31/git-workflow-branch-per-feature/">Git Workflow – Branch per feature</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/03/26/userland-spi-on-the-beaglebone-with-ubuntu/">Userland SPI on the BeagleBone with Ubuntu</a>
      </li>
    
    <li class="post">
      <a href="/blog/archives">More</a>
    </li>
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/amaozn-aws/'>Amaozn AWS (1)</a></li>
<li class='category'><a href='/blog/categories/beaglebone/'>BeagleBone (1)</a></li>
<li class='category'><a href='/blog/categories/enhanced-query-objects/'>Enhanced Query Objects (1)</a></li>
<li class='category'><a href='/blog/categories/mono/'>Mono (1)</a></li>
<li class='category'><a href='/blog/categories/multi-tenancy/'>Multi-tenancy (2)</a></li>
<li class='category'><a href='/blog/categories/sharp-architecture/'>Sharp Architecture (3)</a></li>
<li class='category'><a href='/blog/categories/xcode/'>Xcode (1)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (1)</a></li>
<li class='category'><a href='/blog/categories/ios/'>iOS (1)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yellowfeatheruk", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yellowfeatheruk" class="twitter-follow-button" data-show-count="true">Follow @yellowfeatheruk</a>
  
</section>


<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/yellowfeather">@yellowfeather</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'yellowfeather',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>My Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll...</ul>
  <p><a href="http://pinboard.in/u:yellowfeather">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "yellowfeather"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>




  
</aside>


      </div>
    </div>
    <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Yellow Feather Ltd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'yellowfeather';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://yellowfeather.co.uk/blog/2011/01/11/multi-tenancy-on-sharp-architecture/';
        var disqus_url = 'http://yellowfeather.co.uk/blog/2011/01/11/multi-tenancy-on-sharp-architecture/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  </div>
</body>
</html>
